<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../d2l-table/d2l-table.html">
<link rel="import" href="../d2l-button/d2l-button.html">
<link rel="import" href="../d2l-offscreen/d2l-offscreen.html">
<link rel="import" href="../d2l-simple-overlay/d2l-simple-overlay.html">
<link rel="import" href="../d2l-offscreen/d2l-offscreen.html">
<link rel="import" href="../d2l-inputs/d2l-input-checkbox.html">
<link rel="import" href="../d2l-inputs/d2l-input-checkbox-spacer.html">
<link rel="import" href="src/d2l-localize-behavior.html">
<link rel="import" href="src/d2l-load-more.html">
<!--
`d2l-activity-exemptions`
Activity exemptions

@demo demo/index.html
-->

<dom-module id="d2l-activity-exemptions">
	<template>
		<style>
			:host {
				display: block;
				padding-bottom: 40px;
			}

			paper-toast {
				width: 350px;
				margin-left: calc(50vw - 175px);
				text-align: center;
			}

		</style>
		<style include="d2l-table-style"></style>

		<div role="main">
			<d2l-button
				class="toggle-exemption-buttons"
				role="button"
				aria-label$="[[localize('ariaExempt')]]"
				primary on-click="exemptSelected">
				[[localize('btnExempt')]]
			</d2l-button>

			<d2l-button
				class="toggle-exemption-buttons"
				role="button"
				aria-label$="[[localize('ariaUnexempt')]]"
				on-click="unexemptSelected">
				[[localize('btnUnexempt')]]
			</d2l-button>

			<div id="exemptions-count">
				<p>[[exemptionCount]]</p>
			</div>

			<d2l-table
				id="classlist"
				role="grid"
				summary="[[localize('ariaTableSummary')]]"
				sticky-headers>

				<caption>
					<d2l-offscreen>[[localize('ariaTableCaption')]]</d2l-offscreen>
				</caption>

				<d2l-thead>
					<d2l-tr role="row">
						<d2l-th>
							<d2l-input-checkbox
								aria-label$="[[localize('selectUnselectAll')]]"
								on-change="selectAll">
							</d2l-input-checkbox>
						</d2l-th>

						<d2l-th
							scope="col"
							role="columnheader"
							aria-sort="none">
							[[localize('lblFirstNameLastName')]]
						</d2l-th>

						<d2l-th
							scope="col"
							role="columnheader"
							aria-sort="none">
							[[localize('lblOrgDefinedId')]]
						</d2l-th>

						<d2l-th
							scope="col"
							role="columnheader"
							aria-sort="none">
							[[localize('lblExemptStatus')]]
						</d2l-th>
					</d2l-tr>
				</d2l-thead>

				<d2l-tbody>
					<template
						is="dom-repeat"
						items="[[userData]]"
						observe="IsExempt">

						<d2l-tr
							class="row-user"
							role="row"
							data="[[item]]">

							<d2l-td>
								<d2l-input-checkbox
									class="checkbox-user"
									aria-label$="[[localize('ariaSelectUser', 'lastName', item.LastName, 'firstName', item.FirstName)]]">
								</d2l-input-checkbox>
							</d2l-td>

							<d2l-th
								scope="row"
								role="rowheader"
								class="userfullname">
								[[_getFullName(item.FirstName, item.LastName)]]
							</d2l-th>

							<d2l-th
								scope="row"
								role="rowheader">
								[[item.OrgDefinedId]]
							</d2l-th>

							<d2l-th
								scope="row"
								role="rowheader"
								class="exemptStatus">
								<template is="dom-if" if="[[item.IsExempt]]">
									[[localize('lblExempt')]]
								</template>
								<template is="dom-if" if="[[!item.IsExempt]]">
									<d2l-offscreen>[[localize('lblNotExempt')]]</d2l-offscreen>
								</template>
							</d2l-th>
						</d2l-tr>
					</template>
				</d2l-tbody>
			</d2l-table>

			<template is="dom-if" if="[[hasMoreItems]]">
				<d2l-button
					class="toggle-exemption-buttons"
					role="button"
					aria-label$="[[localize('ariabtnLoadMore')]]"
					on-click="loadMore">
					[[localize('btnLoadMore')]]
				</d2l-button>
			</template>


			<d2l-button
				class="toggle-exemption-buttons"
				role="button"
				aria-label$="[[localize('ariaExempt')]]"
				primary on-click="exemptSelected">
				[[localize('btnExempt')]]
			</d2l-button>

			<d2l-button
				class="toggle-exemption-buttons"
				role="button"
				aria-label$="[[localize('ariaUnexempt')]]"
				on-click="unexemptSelected">
				[[localize('btnUnexempt')]]
			</d2l-button>

			<paper-toast id="toast"></paper-toast>
		</div>
	</template>

	<script>
		/*
			@extends D2L.PolymerBehaviors.ActivityExemptions.LocalizeBehavior
		*/
		class D2LActivityExemptions extends Polymer.mixinBehaviors([
			D2L.PolymerBehaviors.ActivityExemptions.LocalizeBehavior,
			D2L.PolymerBehaviors.ActivityExemptions.LoadMoreExemptionsBehavior
		], Polymer.Element){
			static get is(){
				return 'd2l-activity-exemptions';
			}
			static get properties(){
				return {
					exemptionCount: {
						type: String,
						computed: 'getUserExemptionCount(userData.*)'
					},
					exemptionsUpdateUrl:{
						type: String
					}
				}
			}

			exemptSelected() {
				this._toggleExemption(true);
			}

			getUserExemptionCount() {
				const count = this.userData.filter( u => u.IsExempt ).length;

				// count.toString() is required due to localize returning '' when count is 0
				return this.localize( 'lblExemptionCount', 'exemptionCount', count.toString() );
			}

			selectAll(e) {
				Polymer.dom(this.root).querySelectorAll('.checkbox-user')
					.forEach( element => {
						element.checked = e.target.checked;
					});
			}

			showSaveToast(isExempt, numChanged) {
				var actionText = isExempt ? 'lblExemptSuccess' : 'lblUnexemptSuccess';

				this.$.toast.hide();
				this.$.toast.text = this.localize(actionText, 'itemCount', numChanged);
				this.$.toast.show();
			}

			_toggleExemption(isExempt) {
				var userList = Array.from(this.$.classlist
					.querySelectorAll('.row-user'));
				var filteredSelection = userList
					.filter( (element) => element.querySelector('.checkbox-user[checked]')
						&& element.data['IsExempt'] !== isExempt );
				var token = D2L.LP.Web.Authentication.Xsrf.GetXsrfToken();
				const options = {
					credentials: 'include',
					headers: new Headers({
						'Access-Control-Allow-Origin': '*',
						'Content-Type': 'application/json',
						'X-Csrf-Token': token
					}),
					method: isExempt ? 'POST' : 'DELETE',
					mode: 'cors'
				};

				var allPromises = filteredSelection.map( (element) => {
					return fetch(`${this.exemptionsUpdateUrl}&userId=${element.data.Identifier}`, options)
						.then( () => {
							const rowIndex = element.rowIndex - 1; //offset for header
							this.set(`userData.${rowIndex}.IsExempt`, isExempt);
						});
				});

				Promise.all(allPromises).then(
					() => {
						this.showSaveToast(isExempt, allPromises.length);
					}
				);
			}

			unexemptSelected() {
				this._toggleExemption(false);
			}

			_getFullName(firstName, lastName){
				return `${firstName} ${lastName}`;
			}

		}
		customElements.define(D2LActivityExemptions.is, D2LActivityExemptions);
	</script>
</dom-module>
