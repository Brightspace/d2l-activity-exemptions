<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../d2l-table/d2l-table.html">
<link rel="import" href="../d2l-checkbox/d2l-checkbox.html">
<link rel="import" href="../d2l-button/d2l-button.html">
<link rel="import" href="../d2l-offscreen/d2l-offscreen.html">
<link rel="import" href="../d2l-simple-overlay/d2l-simple-overlay.html">
<link rel="import" href="src/activity-exemptions-username.html">
<link rel="import" href="src/activity-exemptions-exemptstatus.html">

<!--
`activity-exemptions`
Activity exemptions

@demo demo/index.html
-->

<dom-module id="activity-exemptions">
	<template>
		<style>
			:host {
				display: block;
			}
			d2l-button {
				margin: 10px;
			}
			paper-toast {
				width: 350px;
				margin-left: calc(50vw - 175px);
				text-align: center;
			}
		</style>

		<iron-ajax
		id="classlistRequest"
		url="[[classlistUrl]]"
		headers='{ "Authorization": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IjAwZDliM2I2LWQ4MGUtNDZjZC1hYmJlLTdmY2UwNTFiOThkYSJ9.eyJzdWIiOiIxNjkiLCJ0ZW5hbnRpZCI6IjZiZDFjZDc3LWJmOTMtNGEzZi05Mzg5LTcxMzFmY2YyOWE2NiIsInNjb3BlIjoiKjoqOioiLCJqdGkiOiI4YzMzZTQ3Yi05MTRkLTQ5ZWQtYjI3Mi1lNTBhNDAyMTliOTEiLCJpc3MiOiJodHRwczovL2FwaS5icmlnaHRzcGFjZS5jb20vYXV0aCIsImF1ZCI6Imh0dHBzOi8vYXBpLmJyaWdodHNwYWNlLmNvbS9hdXRoL3Rva2VuIiwiZXhwIjoxNTA0NzMwMTQyLCJuYmYiOjE1MDQ3MjY1NDJ9.FbAFAH-bhClXQzN0UqYtWWH8ryd_OV0tcVU9wYyCzBmPoow5TcfsJoLbJAu3Rfglptmyg94WP7N3lFeBRqM4H5qxzx7s3_aitnl_oum24C_5n7Cay6nZaf2Nep8bnEFNL4qCPJVQHJkYkAlxw8DcWR2VtjZiwE0hqy3TrgwGIfFN8vSwYqTwnXVRZBrG26-ofieY0Y_yaO9aglQ3XsVStjWixNdPjZzqa5htDlBDc5Ytyb_W-cog0bQxc_-12whmofSOzFJ1K7oCQKzYi3ZH1ICeK5z8omcvsNGTtRiMxJp8t88UofPZrsdbdS4-WbXGHELlbxdifW3GzuljJiThLw"}'
		handle-as="json"
		on-response="handleClasslistResponse"
		method="GET"
		></iron-ajax>

		<iron-ajax
		id="exemptionsRequest"
		url="[[exemptionsUrl]]"
		headers='{ "Authorization": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IjAwZDliM2I2LWQ4MGUtNDZjZC1hYmJlLTdmY2UwNTFiOThkYSJ9.eyJzdWIiOiIxNjkiLCJ0ZW5hbnRpZCI6IjZiZDFjZDc3LWJmOTMtNGEzZi05Mzg5LTcxMzFmY2YyOWE2NiIsInNjb3BlIjoiKjoqOioiLCJqdGkiOiI4YzMzZTQ3Yi05MTRkLTQ5ZWQtYjI3Mi1lNTBhNDAyMTliOTEiLCJpc3MiOiJodHRwczovL2FwaS5icmlnaHRzcGFjZS5jb20vYXV0aCIsImF1ZCI6Imh0dHBzOi8vYXBpLmJyaWdodHNwYWNlLmNvbS9hdXRoL3Rva2VuIiwiZXhwIjoxNTA0NzMwMTQyLCJuYmYiOjE1MDQ3MjY1NDJ9.FbAFAH-bhClXQzN0UqYtWWH8ryd_OV0tcVU9wYyCzBmPoow5TcfsJoLbJAu3Rfglptmyg94WP7N3lFeBRqM4H5qxzx7s3_aitnl_oum24C_5n7Cay6nZaf2Nep8bnEFNL4qCPJVQHJkYkAlxw8DcWR2VtjZiwE0hqy3TrgwGIfFN8vSwYqTwnXVRZBrG26-ofieY0Y_yaO9aglQ3XsVStjWixNdPjZzqa5htDlBDc5Ytyb_W-cog0bQxc_-12whmofSOzFJ1K7oCQKzYi3ZH1ICeK5z8omcvsNGTtRiMxJp8t88UofPZrsdbdS4-WbXGHELlbxdifW3GzuljJiThLw"}'
		handle-as="json"
		on-response="handleExemptionsResponse"
		method="GET"
		></iron-ajax>

		<iron-ajax
		id="createExemption"
		url="[[createExemptionUrl]]"
		headers='{ "Authorization": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6IjAwZDliM2I2LWQ4MGUtNDZjZC1hYmJlLTdmY2UwNTFiOThkYSJ9.eyJzdWIiOiIxNjkiLCJ0ZW5hbnRpZCI6IjZiZDFjZDc3LWJmOTMtNGEzZi05Mzg5LTcxMzFmY2YyOWE2NiIsInNjb3BlIjoiKjoqOioiLCJqdGkiOiI4YzMzZTQ3Yi05MTRkLTQ5ZWQtYjI3Mi1lNTBhNDAyMTliOTEiLCJpc3MiOiJodHRwczovL2FwaS5icmlnaHRzcGFjZS5jb20vYXV0aCIsImF1ZCI6Imh0dHBzOi8vYXBpLmJyaWdodHNwYWNlLmNvbS9hdXRoL3Rva2VuIiwiZXhwIjoxNTA0NzMwMTQyLCJuYmYiOjE1MDQ3MjY1NDJ9.FbAFAH-bhClXQzN0UqYtWWH8ryd_OV0tcVU9wYyCzBmPoow5TcfsJoLbJAu3Rfglptmyg94WP7N3lFeBRqM4H5qxzx7s3_aitnl_oum24C_5n7Cay6nZaf2Nep8bnEFNL4qCPJVQHJkYkAlxw8DcWR2VtjZiwE0hqy3TrgwGIfFN8vSwYqTwnXVRZBrG26-ofieY0Y_yaO9aglQ3XsVStjWixNdPjZzqa5htDlBDc5Ytyb_W-cog0bQxc_-12whmofSOzFJ1K7oCQKzYi3ZH1ICeK5z8omcvsNGTtRiMxJp8t88UofPZrsdbdS4-WbXGHELlbxdifW3GzuljJiThLw"}'
		handle-as="json"
		on-response="handleIt"
		method="POST"
		></iron-ajax>

		<iron-ajax
		id="loaddata"
		url="test.json"
		handle-as="json"
		on-response="handleTestDataResponse"
		></iron-ajax>

		<div role="main">
			<d2l-button role="button" aria-label="Exempt Selected Users" primary on-tap="exemptSelected">Exempt</d2l-button>
			<d2l-button role="button" aria-label="Unexempt Selected Users" on-tap="unexemptSelected">Unexempt</d2l-button>
			<div id="exemptions-count"><p>
			Exemptions: [[exemptionCount]]
			</p></div>
			<table is="d2l-table" role="grid" summary="The list of users that can have their exemption status modified.">
				<caption><d2l-offscreen>Exempt from activity</d2l-offscreen></caption>
				<thead>
					<tr role="row">
						<th><d2l-checkbox aria-label="Select All Users" on-change="selectAll"></d2l-checkbox></th>
						<th scope="col" role="columnheader" aria-sort="none"><button is="d2l-table-col-sort-button" role="button" nosort>Last Name, First Name</button></th>
						<th scope="col" role="columnheader"><button is="d2l-table-col-sort-button" role="button" nosort>Exempt Status</button></th>
					</tr>
				</thead>
				<tbody>
					<template is="dom-repeat" items="[[userData]]">
						<tr class="row-user" role="row" data="[[item]]">
							<td><d2l-checkbox class="checkbox-user" aria-label="Select [[item.LastName]], [[item.FirstName]]"></d2l-checkbox></td>
							<th scope="row" role="rowheader"><activity-exemptions-username last-name="[[item.LastName]]" first-name="[[item.FirstName]]"></activity-exemptions-username></th>
							<th scope="row" role="rowheader"><activity-exemptions-exemptstatus data="[[item]]"></activity-exemptions-exemptstatus></th>
						</tr>
					</template>
				</tbody>
			</table>
			<d2l-button role="button" aria-label="Exempt Selected Users" primary on-tap="exemptSelected">Exempt</d2l-button>
			<d2l-button role="button" aria-label="Unexempt Selected Users" on-tap="unexemptSelected">Unexempt</d2l-button>
			<paper-toast id="toast"></paper-toast>
			</div>
		</template>

	<script>
		Polymer({

			is: 'activity-exemptions',

			properties: {
				activityId: {
					type: String
				},
				classlistUrl: {
					type: String,
					computed: '_getClasslistUrl(hostUrl, orgUnitId)'
				},
				createExemptionUrl: {
					type: String
				},
				deleteExemptionUrl: {
					type: String
				},
				exemptionsUrl: {
					type: String,
					computed: '_getExemptionsUrl(hostUrl, orgUnitId, activityId)'
				},
				hostUrl: {
					type: String
				},
				orgUnitId: {
					type: String
				},
				rawClasslist: {
					type: Array,
					value: []
				},
				rawExemptions: {
					type: Array,
					value: []
				},
				mappedUserData: {
					type: Object
				},
				userData: {
					type: Array,
					computed: '_getMappedUserData(mappedUserData)'
				},
				testData: {
					type: Boolean
				},
				exemptionCount: {
					type: Number,
					computed: 'getUserExemptionCount(userData.*)'
				}
			},

			ready: function() {
				if (this.testData) {
					this.$.loaddata.generateRequest();
				} else {
					Promise.all([
						this.$.classlistRequest.generateRequest().completes,
						this.$.exemptionsRequest.generateRequest().completes ])
						.then( () => {
							this.mapUserData();
						})
						.catch( () => {
							this.$.toast.text = 'Could not load activity exemption data.';
							this.$.toast.show();
						});
				}
			},

			exemptSelected: function() {
				this._toggleExemption(true);
			},

			getUserExemptionCount: function() {
				return this.userData.filter( u => u.IsExempt ).length;
			},

			handleClasslistResponse: function(e) {
				this.set( 'rawClasslist', e.detail.response );
			},

			handleExemptionsResponse: function(e) {
				this.set( 'rawExemptions', e.detail.response );
			},

			handleTestDataResponse: function(e) {
				this.toMap(e.detail.response);
			},

			handleIt: function(e) {
				console.log(e.detail.response);
			},

			_getClasslistUrl: function(hostUrl, orgUnitId) {
				return `https://${hostUrl}/d2l/api/le/1.12/${orgUnitId}/classlist/`;
			},

			_getExemptionsUrl: function(hostUrl, orgUnitId, activityId) {
				return `https://${hostUrl}/d2l/api/le/1.26/${orgUnitId}/activities/exemptions/?userId=&activityId=${activityId}&showHistory=false`;
			},

			_getMappedUserData: function(mappedUserData) {
				if ( !mappedUserData || !mappedUserData.values ) {
					return [];
				}
				return [...mappedUserData.values()];
			},

			mapUserData: function() {
				const userData = this.rawClasslist.map( (user) => {
					const isExempt = this.rawExemptions.some( (exemptions) => {
						return exemptions['UserId'] === Number(user.Identifier);
					});
					user.IsExempt = isExempt;
					return user;
				});
				this.toMap(userData);
			},

			selectAll: function(e) {
				const checkboxes = Polymer.dom(this.root).querySelectorAll('.checkbox-user');
				if ( e.target.checked ) {
					checkboxes.forEach(function(element) {
						element.checked = true;
					});
				} else {
					checkboxes.forEach(function(element) {
						element.checked = false;
					});
				}
			},

			showSaveToast: function(isExempt, numChanged) {
				var actionText = isExempt ? 'exempted' : 'unexempted';
				var userText = ( numChanged === 1 ) ? 'user' : 'users';

				this.$.toast.hide();
				this.$.toast.text = `Saved successfully. ${numChanged} ${userText} ${actionText}.`;
				this.$.toast.show();
			},

			_toggleExemption: function(isExempt) {
				var filteredSelection = Polymer.dom(this.root)
					.querySelectorAll('.row-user')
					.filter( (element) => element.querySelector('.checkbox-user[checked]')
						&& element.data['IsExempt'] !== isExempt );

				var allPromises = filteredSelection.map( (element) => {
					const user = this.mappedUserData.get(element.data.Identifier);
					this.createExemptionUrl =  `https://${this.hostUrl}/d2l/api/le/1.26/${this.orgUnitId}/activities/exemptions?userId=${user.Identifier}&activityId=${this.activityId}`;

					return this.$.createExemption.generateRequest().completes.then( function(){
					    user.IsExempt = true;
					});
				});

				Promise.all(allPromises).then( () =>{
                    // Deep copy of the mappedUserData to notify polymer that value has been changed
                    const mapCopy = JSON.stringify([...this.mappedUserData.entries()]);
                    this.mappedUserData = new Map(JSON.parse(mapCopy));

                    this.showSaveToast( isExempt, allPromises.length );
				    console.log('all promises done'); }
				);

			},

			toMap: function(rawData) {
				const map = new Map();
				rawData.forEach( (userData) => {
					map.set(userData.Identifier, userData);
				});
				this.set('mappedUserData', map);
			},

			unexemptSelected: function() {
				this._toggleExemption(false);
			}

		});
	</script>
</dom-module>
