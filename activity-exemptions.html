<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../d2l-table/d2l-table.html">
<link rel="import" href="../d2l-checkbox/d2l-checkbox.html">
<link rel="import" href="../d2l-button/d2l-button.html">
<link rel="import" href="../d2l-offscreen/d2l-offscreen.html">
<link rel="import" href="../d2l-simple-overlay/d2l-simple-overlay.html">
<link rel="import" href="src/activity-exemptions-username.html">
<link rel="import" href="src/activity-exemptions-exemptstatus.html">
<link rel="import" href="src/d2l-localize-behavior.html">
<link rel="import" href="src/d2l-load-more.html">
<!--
`activity-exemptions`
Activity exemptions

@demo demo/index.html
-->

<dom-module id="activity-exemptions">
	<template>
		<style>
			:host {
				display: block;
				padding-bottom: 40px;
			}

			.toggle-exemption-buttons {
				margin: 10px;
			}

			paper-toast {
				width: 350px;
				margin-left: calc(50vw - 175px);
				text-align: center;
			}

			.load-more {
				cursor: pointer;
				text-align: center;
			}
		</style>

		<div role="main">

			<button
				is="d2l-button"
				class="toggle-exemption-buttons"
				role="button"
				aria-label$="[[localize('ariaExempt')]]"
				primary on-tap="exemptSelected">
				[[localize('btnExempt')]]
			</button>

			<button
				is="d2l-button"
				class="toggle-exemption-buttons"
				role="button"
				aria-label$="[[localize('ariaUnexempt')]]"
				on-tap="unexemptSelected">
				[[localize('btnUnexempt')]]
			</button>

			<div id="exemptions-count">
				<p>[[exemptionCount]]</p>
			</div>

			<table
				is="d2l-table"
				role="grid"
				summary="[[localize('ariaTableSummary')]]">

				<caption>
					<d2l-offscreen>[[localize('ariaTableCaption')]]</d2l-offscreen>
				</caption>

				<thead>
					<tr role="row">
						<th>
							<d2l-checkbox
								aria-label$="[[localize('selectUnselectAll')]]"
								on-change="selectAll">
							</d2l-checkbox>
						</th>

						<th
							scope="col"
							role="columnheader"
							aria-sort="none">

							<button
								is="d2l-table-col-sort-button"
								role="button"
								nosort>
								[[localize('lblLastNameFirstName')]]
							</button>
						</th>

						<th
							scope="col"
							role="columnheader">
							<button
								is="d2l-table-col-sort-button"
								role="button"
								nosort>
								[[localize('lblExemptStatus')]]
							</button>
						</th>
					</tr>
				</thead>

				<template is="dom-if" if="[[hasMoreItems]]">
					<tfoot>
						<tr role="row">
							<td
								class="load-more"
								scope="row"
								colspan="3"
								on-tap="loadMore"
								tabindex="0">
								Load More...
							</td>
						</tr>
					</tfoot>
				</template>

				<tbody>
					<template
						is="dom-repeat"
						items="[[userData]]"
						observe="IsExempt">

						<tr
							class="row-user"
							role="row"
							data="[[item]]">

							<td>
								<d2l-checkbox
									class="checkbox-user"
									aria-label$="[[localize('ariaSelectUser', 'lastName', item.LastName, 'firstName', item.FirstName)]]">
								</d2l-checkbox>
							</td>

							<th
								scope="row"
								role="rowheader">
								<activity-exemptions-username
									first-name="[[item.FirstName]]"
									last-name="[[item.LastName]]">
								</activity-exemptions-username>
							</th>

							<th
								scope="row"
								role="rowheader">
								<activity-exemptions-exemptstatus
									is-exempt="[[item.IsExempt]]">
								</activity-exemptions-exemptstatus>
							</th>
						</tr>
					</template>
				</tbody>
			</table>

			<button
				is="d2l-button"
				class="toggle-exemption-buttons"
				role="button"
				aria-label$="[[localize('ariaExempt')]]"
				primary on-tap="exemptSelected">
				[[localize('btnExempt')]]
			</d2l-button>

			<button
				is="d2l-button"
				class="toggle-exemption-buttons"
				role="button"
				aria-label$="[[localize('ariaUnexempt')]]"
				on-tap="unexemptSelected">
				[[localize('btnUnexempt')]]
			</button>

			<paper-toast id="toast"></paper-toast>
		</div>
	</template>

	<script>
		Polymer({

			is: 'activity-exemptions',
			behaviors: [
				D2L.PolymerBehaviors.ActivityExemptions.LocalizeBehavior,
				D2L.PolymerBehaviors.ActivityExemptions.LoadMoreExemptionsBehavior
			],

			properties: {
				exemptionCount: {
					type: String,
					computed: 'getUserExemptionCount(userData.*)'
				},
				exemptionsUpdateUrl:{
					type: String
				}
			},

			exemptSelected() {
				this._toggleExemption(true);
			},

			getUserExemptionCount() {
				const count = this.userData.filter( u => u.IsExempt ).length;

				// count.toString() is required due to localize returning '' when count is 0
				return this.localize( 'lblExemptionCount', 'exemptionCount', count.toString() );
			},

			selectAll(e) {
				Polymer.dom(this.root).querySelectorAll('.checkbox-user')
					.forEach( element => {
						element.checked = e.target.checked;
					});
			},

			showSaveToast(isExempt, numChanged) {
				var actionText = isExempt ? 'lblExemptSuccess' : 'lblUnexemptSuccess';

				this.$.toast.hide();
				this.$.toast.text = this.localize(actionText, 'itemCount', numChanged);
				this.$.toast.show();
			},

			_toggleExemption(isExempt) {
				var filteredSelection = Polymer.dom(this.root)
					.querySelectorAll('.row-user')
					.filter( (element) => element.querySelector('.checkbox-user[checked]')
						&& element.data['IsExempt'] !== isExempt );
				var token = D2L.LP.Web.Authentication.Xsrf.GetXsrfToken();
				const options = {
					credentials: 'include',
					headers: new Headers({
						'Access-Control-Allow-Origin': '*',
						'Content-Type': 'application/json',
						'X-Csrf-Token': token
					}),
					method: isExempt ? 'POST' : 'DELETE',
					mode: 'cors'
				};

				var allPromises = filteredSelection.map( (element) => {
					return fetch(`${this.exemptionsUpdateUrl}&userId=${element.data.Identifier}`, options)
						.then( () => {
							const rowIndex = element.rowIndex - 1; //offset for header
							this.set(`userData.${rowIndex}.IsExempt`, isExempt);
						});
				});

				Promise.all(allPromises).then(
					() => {
						this.showSaveToast(isExempt, allPromises.length);
					}
				);
			},

			unexemptSelected() {
				this._toggleExemption(false);
			}
		});
	</script>
</dom-module>
