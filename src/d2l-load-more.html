<script>
(function() {
	'use strict';

	var options = {
		credentials: 'include',
		headers: {
			'Access-Control-Allow-Origin': '*'
		},
		mode: 'cors'
	};

	/* @polymerBehavior D2L.PolymerBehaviors.ActivityExemptions.LoadMoreExemptionsBehavior */
	var LoadMoreExemptionsBehavior = {
		properties: {
			bookmark: {
				type: String
			},
			classlistUrl: {
				type: String
			},
			exemptions: {
				type: Array
			},
			exemptionsUrl: {
				type: String
			},
			hasMoreItems: {
				type: Boolean
			},
			classlistItems: {
				type: Array,
				value: []
			},
			userData: {
				type: Array,
				value: []
			},
			page: {
				type: Number,
				value: 0
			}
		},
		ready: function() {
			var self = this;
			Promise.all([
				fetch(this.classlistUrl, options)
					.then( function(r) { return r.json(); })
					.then( function(d) { return self.__loadPagedData(d); }),
				fetch(this.exemptionsUrl, options)
					.then( function(r) { return r.json(); })
					.then( function(b) { return self.exemptions = b; })
			])
				.then( function() {
					self.__mapUserData();

					var body = self.$$('.tableBody');

					self.userData.forEach( function(element) {
						var tr = document.createElement('tr');
						tr.className = 'row-user';
						tr.setAttribute('role', 'row');
						tr.setAttribute('Identifier', element.Identifier);
						tr.setAttribute('IsExempt', element.IsExempt);

						var tdCheckbox = document.createElement('td');
						var rowCheckbox = document.createElement('d2l-checkbox');
						rowCheckbox.className = 'checkbox-user';
						rowCheckbox.setAttribute('aria-label', element.FirstName);
						tdCheckbox.appendChild(rowCheckbox);
						tr.appendChild(tdCheckbox);

						var thUserName = document.createElement('th');
						thUserName.setAttribute('scope', 'row');
						thUserName.setAttribute('role', 'rowheader');
						var usernameElem = document.createElement('activity-exemptions-username');
						usernameElem.setAttribute('first-name', element.FirstName);
						usernameElem.setAttribute('last-name', element.LastName);
						thUserName.appendChild(usernameElem);
						tr.appendChild(thUserName);

						var thExemptStatus = document.createElement('th');
						thExemptStatus.setAttribute('scope', 'row');
						thExemptStatus.setAttribute('role', 'rowheader');
						var exemptStatusElem = document.createElement('activity-exemptions-exemptstatus');
						exemptStatusElem.setAttribute('is-exempt', element.IsExempt);
						thExemptStatus.appendChild(exemptStatusElem);
						tr.appendChild(thExemptStatus);
						body.appendChild(tr);

					});
				})
				.catch( function() {
					self.$.toast.text = self.localize('lblCouldNotLoad');
					self.$.toast.show();
				});
		},
		loadMore: function() {

			var self = this;
			var url = this.classlistUrl;

			if ( this.bookmark ) {
				url += '?bookmark=' + this.bookmark;
			}

			fetch(url, options)
				.then( function(r) { return r.json(); })
				.then( function(d) {
					self.__loadPagedData(d);
					self.__mapUserData();
				});
		},
		__mapUserData: function() {
			var self = this;
			this.set('userData', self.classlistItems.map(
				function(user) {
					user.IsExempt = self.exemptions.some( function(e) {
						return e.UserId.toString() === user.Identifier.toString();
					});

					return user;
				}
			));
		},
		__loadPagedData: function(pagedData) {
			var self = this;
			this.page++;
			this.bookmark = pagedData.PagingInfo.Bookmark;
			this.hasMoreItems = pagedData.PagingInfo.HasMoreItems;

			pagedData.Items.forEach( function(item)  {
				self.push('classlistItems', item);
			});
		}
	};

	window.D2L = window.D2L || {};
	window.D2L.PolymerBehaviors = window.D2L.PolymerBehaviors || {};
	window.D2L.PolymerBehaviors.ActivityExemptions = window.D2L.PolymerBehaviors.ActivityExemptions || {};

	/* @polymerBehavior */
	window.D2L.PolymerBehaviors.ActivityExemptions.LoadMoreExemptionsBehavior = LoadMoreExemptionsBehavior;
})();
</script>
